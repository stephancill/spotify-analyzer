<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Spotify Library Analyer</title>
        <link href="https://fonts.googleapis.com/css?family=Press+Start+2P" rel="stylesheet">
    </head>
    <body style="font-family: 'Open Sans Condensed', sans-serif;">
        <div style="text-align:center;">
            <h1 style="text-align:center" id="title">Spotify Library Analyzer <sub>(<span id="version"></span>)</sub></h1>
            <h2 id="fetchStatus">Fetching/parsing songs...</h2>
            (<span id="totalLookedUp">0</span><span>/</span><span id="totalSongs">?</span>)
            <span>(ETA: </span><span id="eta"></span><span> seconds)</span>

            <div id="currentContainer">
                <span >Current: </span><span id="current"></span>
            </div>

            <div id="charts" style="visibility: hidden;margin-left:auto;margin-right:auto;margin-top:20px">
                <div class="" style="padding-bottom:20px">
                    <span >Found <span id="feedback"></span>.</span>
                    <br>
                </div>
                <canvas id="myChart" width="500" height="500"></canvas>
                <br>
                <a id="twitter" href="https://twitter.com/share"  class="twitter-share-button" data-size="large" data-text="Find the 6 most popular genres in your Spotify library with " data-url="https://stephancill.github.io/spotify-analyzer/" data-related="stephancill" data-show-count="false">Tweet</a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

            </div>
            <p>Made by <a target="_blank" href="https://twitter.com/stephancill">@stephancill</a></p>

        </div>
        <a target="_blank" href="https://github.com/stephancill/spotify-analyzer"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>
    </body>
</html>
<script type="text/javascript">

var version = "v0.1.9"
console.log(version);
document.getElementById("version").innerHTML = version

var spotify_client_id = '04ec33bc2f0544b4b06c9c78c251ff07'; // Your client id (meh)
var redirect_uri = location.origin+location.pathname

var auth_url = `https://accounts.spotify.com/authorize?client_id=${spotify_client_id}&response_type=token&redirect_uri=${encodeURIComponent(redirect_uri)}&scope=user-library-read%20user-read-private%20user-read-email`

var access_token = null
var refresh_token = null

var spotify_client_id = null

var lastfm_api_key = "b25b959554ed76058ac220b7b2e0a026"

var songs = []
var requestedSongs = []
var songsWithTags = 0
var songTags = 0
var lastFMProcessIndex = 0
var timer = null

var genreDemographics = {}
var chartsCreated = false

if (location.hash != "") {
    authenticate(spotify_client_id, redirect_uri, populateSongs)
    window.history.pushState('page2', 'Title', location.pathname);
} else {
    location.replace(auth_url)
}

function authenticate(spotify_client_id, redirect_uri, callback) {
    var access_token = null
    function gup(name, url) {
        if (!url) url = location.href;
        name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]")
        var regexS = "[\\?&]"+name+"=([^&#]*)"
        var regex = new RegExp( regexS )
        var results = regex.exec( url )
        return results == null ? null : results[1]
    }

    if (!(gup("error"))) {
        access_token = `${location.hash}`.substring(location.hash.indexOf("=")+1, location.hash.indexOf("&"))
        callback(access_token)
    } else {
        console.error("Error");
    }
}

function populateSongs(access_token) {
    var endpoint = "https://api.spotify.com/v1/me/tracks"
    var headers = new Headers()
    headers.append('Content-Type', 'application/x-www-form-urlencoded;charset=UTF-8')
    headers.append('Authorization', "Bearer " + access_token)

    var request = { method: 'GET',
                   headers: headers,
                   mode: 'cors',
                   cache: 'default' }

    var requestsMade = 0
    var limit = 50

    // Set username
    fetch("https://api.spotify.com/v1/me", request)
    .then((blob) => blob.json())
    .then((data) => {
        spotify_client_id = data.id
    })

    fetch(endpoint + `?limit=${limit}&offset=${requestsMade * limit}`, request)
    .then((blob) => blob.json())
    .then((data) => {
        data.items.map(item => {
            songs.push({title: item.track.name, artist: item.track.artists[0].name})
        })
        getTagsForSongs()
        updateSongCount(data.items)
        recursiveGet(data, endpoint, request, requestsMade+1, limit)
    })
}

function recursiveGet(responseData, endpoint, request, requestsMade, limit, maxRequests=null, callback=()=>{}) {
    if (maxRequests !== null) {
        if (requestsMade > maxRequests) {
            callback()
            return
        }
    }
    if (!(responseData.items.length < limit)) {
        fetch(endpoint + `?limit=${limit}&offset=${requestsMade * limit}`, request)
        .then((blob) => blob.json())
        .then((data) => {
            data.items.map(item => {
                songs.push({title: item.track.name, artist: item.track.artists[0].name})
            })
            updateSongCount(data.items)
            // recursiveGet(data, endpoint, request, requestsMade+1, limit, 2)
            recursiveGet(data, endpoint, request, requestsMade+1, limit, maxRequests, callback)
        })
    } else {
        callback()
    }
}

function getTagsForSongs() {
    console.warn("Getting tags");
    timer = window.setInterval(getSongTags, 200) // Last.fm limits requests to 5 per second per IP
}

function getSongTags() {
    if (lastFMProcessIndex < songs.length) {
        var title = songs[lastFMProcessIndex].title
        var artist = songs[lastFMProcessIndex].artist
        var endpoint = `https://ws.audioscrobbler.com/2.0/?method=track.getInfo&api_key=${lastfm_api_key}`
        var params = `&artist=${encodeURIComponent(artist)}&track=${encodeURIComponent(title)}`
        var appendix = "&user=RJ&format=json"
        fetch(endpoint + params + appendix)
        .then(blob => blob.json())
        .then(data => {
            tags =  data.track.toptags.tag
            songsWithTags++
            tags.map(tag => {
                item = tag.name
                if (lastFMProcessIndex < songs.length) {
                    songTags++
                    if (genreDemographics[item]) {
                        genreDemographics[item]["count"] += 1
                        genreDemographics[item]["tracks"].push(songs[lastFMProcessIndex])
                    } else {
                        genreDemographics[item] = {}
                        genreDemographics[item]["count"] = 1
                        genreDemographics[item]["tracks"] = [songs[lastFMProcessIndex]]
                    }
                }
            })
            requestedSongs.push({title: title, artist: artist, tags: tags})
            document.getElementById("totalLookedUp").innerHTML = lastFMProcessIndex
            document.getElementById("eta").innerHTML = 200 * (songs.length - lastFMProcessIndex) / 1000
            document.getElementById("current").innerHTML = title + " - " + artist
        })
        lastFMProcessIndex += 1
    } else if (!chartsCreated){
        window.clearInterval(timer)
        document.getElementById("fetchStatus").innerHTML = "Done."
        analyzeSongs()
        chartsCreated = true
    }

}

function analyzeSongs() {
    console.log("Analyzing");
    // console.log(genreDemographics);
    var keysSorted = Object.keys(genreDemographics).sort(function(b,a){return genreDemographics[a].count-genreDemographics[b].count})
    var tabulated = []
    for (var i = 0; i < keysSorted.length; i++) {
        // console.log(genreDemographics[keysSorted[i]].tracks);
        tabulated.push([keysSorted[i], genreDemographics[keysSorted[i]].count, genreDemographics[keysSorted[i]].tracks])
    }
    console.table(tabulated)
    document.getElementById("feedback").innerHTML = `Found ${songTags} tags for ${songsWithTags} songs`
    document.getElementById("charts").style.visibility = "visible"
    document.getElementById("currentContainer").style.visibility = "hidden"
    // Charts
    var labels = []
    var data = []
    for (var i = 0; i < 7; i++) {
        labels.push(tabulated[i][0])
        data.push(tabulated[i][1])
    }
    Chart.defaults.global.responsive = false
    var ctx = document.getElementById("myChart");
    var myChart = new Chart(ctx, {
        type: "bar",
        data: {
            labels: labels,
            datasets: [{
                label: '# of songs',
                data: data,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.2)',
                    'rgba(54, 162, 235, 0.2)',
                    'rgba(255, 206, 86, 0.2)',
                    'rgba(75, 192, 192, 0.2)',
                    'rgba(153, 102, 255, 0.2)',
                    'rgba(255, 159, 64, 0.2)',
                    'rgba(255, 60, 160, 0.2)'
                ],
                borderColor: [
                    'rgba(255,99,132,1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)',
                    'rgba(255, 60, 160, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero:true
                    }
                }]
            },
            title: {
                display: true,
                text: `Top 6 genres for ${spotify_client_id} on ${printDate()}`
            }
        }
    })
    ctx.style.display = "inline"
}

function updateSongCount(tracks) {
    document.getElementById("totalSongs").innerHTML = songs.length
}

function printDate() {
    var temp = new Date();
    var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]
    var dateStr = `${temp.getDate()} ${months[temp.getMonth()]} ${temp.getFullYear()}`
    // debug (dateStr );
    return dateStr
}

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.js" charset="utf-8"></script>
